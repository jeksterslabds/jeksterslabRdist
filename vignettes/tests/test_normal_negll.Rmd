---
title: "Test: Normal - Negative Log-Likelihood"
author: "Ivan Jacob Agaloos Pesigan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Test: Normal - Negative Log-Likelihood}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r knitr_options, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  error = TRUE,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```



```{r setup}
library(testthat)
library(microbenchmark)
library(jeksterslabRdist)
context("Test Normal - Negative Log-Likelihood.")
```


## Parameters


```{r parameters}
n <- 50
mu <- runif(
  n = 1,
  min = -1,
  max = 1
)
sigma <- runif(
  n = 1,
  min = 1,
  max = 2
)
Variable <- c(
  "`n`",
  "`mu`",
  "`sigma`"
)
Description <- c(
  "Sample size ($n$).",
  "Population mean ($\\mu$).",
  "Population standard deviation ($\\sigma$)."
)
Value <- c(
  n,
  mu,
  sigma
)
knitr::kable(
  x = data.frame(
    Variable,
    Description,
    Value
  ),
  row.names = FALSE
)
```


## Generate Data


```{r generate_data}
x <- rnorm(
  n = n,
  mean = mu,
  sd = sigma
)
x_bar <- mean(x)
s <- sd(x)
Variable <- c(
  "`n`",
  "`x_bar`",
  "`s`"
)
Description <- c(
  "Sample size ($n$).",
  "Sample mean ($\\bar{x}$).",
  "Sample standard deviation ($s$)."
)
Value <- c(
  n,
  x_bar,
  s
)
knitr::kable(
  x = data.frame(
    Variable,
    Description,
    Value
  ),
  row.names = FALSE
)
```


## Negative Log-Likelihood


```{r negll}
results_dnorm <- -1 * sum(
  dnorm(
    x = x,
    mean = mu,
    sd = sigma,
    log = TRUE
  )
)
results_normal_negll <- normal_negll(
  theta = c(mu, sigma),
  x = x
)
```


## Maximum Likelihood Estimation


```{r ml}
foo <- function(theta, x) {
  -1 * sum(
    dnorm(
      x = x,
      mean = theta[1],
      sd = theta[2],
      log = TRUE
    )
  )
}
results_ml_dnorm <- opt(
  FUN = foo,
  start_values = c(mu, sigma),
  optim = TRUE,
  x = x
)
results_ml_normal_negll <- opt(
  FUN = normal_negll,
  start_values = c(mu, sigma),
  optim = TRUE,
  x = x
)
```


## Summarize Results


```{r results}
knitr::kable(
  x = data.frame(
    dnorm = results_dnorm,
    normal_negll = results_normal_negll
  ),
  row.names = FALSE,
  caption = "Negative Log-Likelihood"
)
knitr::kable(
  x = data.frame(
    Item = c("$\\mu$", "$\\sigma$"),
    Parameter = c(mu, sigma),
    Sample = c(x_bar, s),
    dnorm = results_ml_dnorm$par,
    normal_negll = results_ml_normal_negll$par
  ),
  row.names = FALSE,
  col.names = c(
    "Item",
    "Parameter",
    "Closed-form solution",
    "MLE using dnorm",
    "MLE using normal_negll"
  ),
  caption = "Maximum Likelihood Estimates (MLE)"
)
```


## Benchmarking


```{r benchmark}
microbenchmark(
  dnorm = -1 * sum(dnorm(x = x, mean = mu, sd = sigma, log = TRUE)),
  normal_negll = normal_negll(theta = c(mu, sigma), x = x)
)
microbenchmark(
  ml_dnorm = opt(FUN = foo, start_values = c(mu, sigma), optim = TRUE, x = x),
  ml_normal_negll = opt(FUN = normal_negll, start_values = c(mu, sigma), optim = TRUE, x = x)
)
```


## testthat


```{r testthat_01, echo=TRUE}
test_that("normal_negll returns the same value as dnorm", {
  expect_equivalent(
    round(
      x = results_dnorm,
      digits = 2
    ),
    round(
      x = results_normal_negll,
      digits = 2
    )
  )
})
```



```{r testthat_02, echo=TRUE}
test_that("normal_negll maximizes to the same estimates as dnorm", {
  expect_equivalent(
    round(
      x = results_ml_dnorm$par,
      digits = 2
    ),
    round(
      x = results_ml_normal_negll$par,
      digits = 2
    )
  )
})
```

